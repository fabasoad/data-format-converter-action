---
name: 'YAML/JSON/XML Converter Action'
author: Yevhen Fabizhevskyi
description: 'This action takes file that in YAML/JSON/XML format and produces it in output in YAML/JSON/XML format.'
branding:
  icon: copy
  color: green
inputs:
  input:
    description: 'Path to the file with the data or data itself'
    required: true
  from:
    description: 'Format of a file. Possible values: json, xml, yaml, toml.'
    required: true
  to:
    description: 'Format of a file as a result. Possible values: json, xml, yaml, toml.'
    required: true
  output-type:
    description: 'Either path to the file with the converted data or converted data itself. Possible values: file, data.'
    required: false
    default: 'data'
outputs:
  output:
    description: 'File with the converted data in case of output-type is "file", otherwise - converted data itself.'
    value: ${{ steps.result.outputs.data }}
runs:
  using: 'composite'
  steps:
    - name: Collect yq info
      id: yq_info
      env:
        YQ_VERSION: v4.28.1
      run: |
        echo "YQ_VERSION=$YQ_VERSION" >> $GITHUB_OUTPUT
        result=$(if command -v yq >/dev/null 2>&1; then echo true; else echo false; fi)
        echo "YQ_INSTALLED=$result" >> $GITHUB_OUTPUT
        if [[ "${{ runner.os }}" == "macOS" ]]; then
          if [[ "${{ runner.arch }}" == "ARM64" ]]; then
            YQ_BINARY=yq_darwin_arm64
          else
            YQ_BINARY=yq_darwin_amd64
          fi
        elif [[ "${{ runner.os }}" == "Windows" ]]; then
          if [[ "${{ runner.arch }}" == "X86" ]]; then
            YQ_BINARY=yq_windows_386.exe
          else
            YQ_BINARY=yq_windows_amd64.exe
          fi
        elif [[ "${{ runner.os }}" == "Linux" ]]; then
          if [[ "${{ runner.arch }}" == "X86" ]]; then
            YQ_BINARY=yq_linux_386
          elif [[ "${{ runner.arch }}" == "ARM" ]]; then
            YQ_BINARY=yq_linux_arm
          elif [[ "${{ runner.arch }}" == "ARM64" ]]; then
            YQ_BINARY=yq_linux_arm64
          else
            YQ_BINARY=yq_linux_amd64
          fi
        else
          echo "::error file=action.yml,line=44,col=11,endColumn=11::${{ runner.os }} is not supported"
          exit 1
        fi
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          echo "YQ_EXEC=yq.exe" >> $GITHUB_OUTPUT
        else
          echo "YQ_EXEC=yq" >> $GITHUB_OUTPUT
        fi
        echo "YQ_BINARY=$YQ_BINARY" >> $GITHUB_OUTPUT
      shell: bash
    - name: Install mikefarah/yq (Linux / macOS)
      if: ${{ steps.yq_info.outputs.YQ_INSTALLED == 'false' && inputs.from != 'xml' && runner.os != 'Windows' }}
      env:
        YQ_URL: https://github.com/mikefarah/yq/releases/download/${{ steps.yq_info.outputs.YQ_VERSION }}/${{ steps.yq_info.outputs.YQ_BINARY }}
      run: |
        wget $YQ_URL -O .
        mv ${{ steps.yq_info.outputs.YQ_BINARY }} ${{ steps.yq_info.outputs.YQ_EXEC }}
        chmod +x ${{ steps.yq_info.outputs.YQ_EXEC }}
      shell: bash
    - name: Install mikefarah/yq (Windows)
      if: ${{ steps.yq_info.outputs.YQ_INSTALLED == 'false' && inputs.from != 'xml' && runner.os == 'Windows' }}
      env:
        YQ_URL: https://github.com/mikefarah/yq/releases/download/${{ steps.yq_info.outputs.YQ_VERSION }}/${{ steps.yq_info.outputs.YQ_BINARY }}
      run: Invoke-WebRequest -URI $Env:YQ_URL -OutFile ${{ steps.yq_info.outputs.YQ_EXEC }}
      shell: pwsh
    - name: Add mikefarah/yq to PATH
      if: ${{ steps.yq_info.outputs.YQ_INSTALLED == 'false' && inputs.from != 'xml' }}
      run: |
        echo "$(pwd)" >> $GITHUB_PATH
        echo "::debug::${{ steps.yq_info.outputs.YQ_BINARY }}@${{ steps.yq_info.outputs.YQ_VERSION }} has been installed"
      shell: bash
    # From YAML/JSON
    - name: YAML/JSON to all
      if: ${{ inputs.from != 'xml' }}
      run: |
        params=('-P' '${{ inputs.input }}' '-o=${{ inputs.to }}')
        if [[ "${{ inputs.to }}" != "yaml" ]]; then
          params+=('-I=0')
        fi
        ${{ steps.yq_info.outputs.YQ_EXEC }} "${params[@]}" > .data-format-converter-action
      shell: bash
    - name: Uninstall mikefarah/yq
      if: ${{ steps.yq_info.outputs.YQ_INSTALLED == 'false' && inputs.from != 'xml' }}
      run: rm -f ${{ steps.yq_info.outputs.YQ_EXEC }}
      shell: bash
    # From XML
    - name: Install kislyuk/yq
      if: ${{ inputs.from == 'xml' }}
      run: pip install yq==3.1.0
      shell: bash
    - name: XML to all
      if: ${{ inputs.from == 'xml' }}
      run: |
        data=$(xq . '${{ inputs.input }}' -c)
        if [[ "${{ inputs.to }}" == "yaml" ]]; then
          data=$(echo $data | yq -y .)
        fi
        echo $data > .data-format-converter-action
      shell: bash
    - name: Uninstall kislyuk/yq
      if: ${{ inputs.from == 'xml' }}
      run: pip uninstall -y yq
      shell: bash
    # Output
    - name: Save output
      id: result
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const file = '.data-format-converter-action';
          core.setOutput('data', fs.readFileSync(file, 'utf8'));
          fs.unlinkSync(file);
